kubectl create secret generic buildkite-agent --from-literal=token=YOUR_BUILKITE_TOKEN

kubectl apply -f .buildkite/deployment.yml
kubectl scale --replicas=5 deployment buildkite-agent

DOCKER_BUILDKIT=1 docker build -t kibana-ci .
docker run -it kibana-ci sh

  
kubectl create secret docker-registry gcr-json-key \
--docker-server=gcr.io \
--docker-username=_json_key \
--docker-password="$(cat ~/json-key-file.json)" \
--docker-email=tyler.smalley@elastic.co

kubectl patch serviceaccount default \
-p '{"imagePullSecrets": [{"name": "gcr-json-key"}]}'


kubectl get serviceaccount default -o yaml

helm install bk --namespace default buildkite/agent --set agent.token="YOUR_BUILKITE_TOKEN" --set registryCreds.gcrServiceAccountKey="$(cat ~/gcr_service_account.json | base64)" --set agent.tags="docker=true"

kubectl --namespace=default get pods -l "app=agent,release=bk"
helm upgrade {{ template "fullname" . }} builkite/agent \
      --set agent.token="YOUR_BUILKITE_TOKEN"
